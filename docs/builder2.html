<head>
    <style>
        body {
            /* background-color: #222222; */
            /* color: #fff; */
        }
        
        .axes {
            width: 400px;
            height: 400px;
            margin: 0;
            margin-right: 20px;
            margin-bottom: 20px;
            display: inline-block;
            background: black;
        }
    </style>
</head>
<body>
    Save for later: <input id="save" type="button" value="Save"> <br>
    Load from file: <input id="load" type="file" value="Load" accept=".json"> <br>
    Export as code: <input id="export" type="button" value="Export"> <br> <br>
    <select id="axestype">
        <option>2D</option>
        <option>3D</option>
    </select>
    <input id="addaxes" type="button" value="Add Axes"> <br>
    <input id="addexpr" type="button" value="Add Expression"> 
    
    <div id="plot">
        <div id="expressions"></div>
        <div id="axes"></div>
    </div>
    
    <script src="../lib/jquery-3.3.1.min.js"></script>
    <script src="../lib/three.min.js"></script>
    <script src="../build/interactive.js"></script>
    <script>
        var plot = new Interactive.Plot();
        
        var aid = 0;
        var axesInfo = {};
        
        var eid = 0;
        var expressionsInfo = {};
        
        var pid = 0;
        var plotInfo = {};
        
        
        var compile = function() {
            var plotInitCode = [
            'plot = new Interactive.Plot();',
            ];
            
            var compileAxesInitCode = function(ai) {
                var initCode = 'ax' + ai.id + ' = ';
                if(ai.type == '2D') initCode += 'plot.createAxes2D('; 
                if(ai.type == '3D') initCode += 'plot.createAxes3D('; 
                initCode += 'document.getElementById("ax' +  ai.id + '")';
                // other properties will go here
                initCode += ');';
                return initCode;
            }
            
            var compileAxesDrawCode = function(ai, pi) {
                var plotCode = 'ax' + ai.id + '.plotExpression("';
                if(pi.values.expr) {
                    plotCode += pi.values.expr;
                }
                if(pi.values.interval) {
                    plotCode += '{';
                    plotCode += pi.values.interval.variable;
                    plotCode += ',';
                    plotCode += pi.values.interval.start;
                    plotCode += ',';
                    plotCode += pi.values.interval.end;
                    plotCode += ',';
                    plotCode += pi.values.interval.steps;
                    plotCode += '}';
                }
                plotCode += '"';
                plotCode += ','
                switch(pi.type) {
                    case 'Parametric Curve': 
                    plotCode += '"parametric"';
                    break;
                }
                plotCode += ',{';
                if(pi.values.useColor) {
                    plotCode += 'color:"';
                    plotCode += pi.values.color;
                    plotCode += '",'; 
                }
                // other properties will go here
                plotCode += '});';
                return plotCode;
            }
            
            var axInitCode = [
            
            ];
            var axDrawCode = [
            
            ];
            
            for(var key in axesInfo) {
                var ai = axesInfo[key];
                var initCode = compileAxesInitCode(ai);
                axInitCode.push(initCode);
                
                ai.plotIds.forEach((pid) => {
                    var pi = plotInfo[pid];
                    if(pi.valid) {
                        var plotCode = compileAxesDrawCode(ai, pi);
                        axDrawCode.push(plotCode);
                    }
                });
            }
            
            var compileExpressionCode = function(ex) {
                var code = 'ex' + ex.id + ' = ';
                code += 'plot.execExpression("';
                code += ex.expr;
                code += '");';
                return code;
            }
            
            var expressionCode = [
            
            ];
            
            var exprInfoSortedKeys = Object.keys(expressionsInfo);
            exprInfoSortedKeys.sort((a, b) => expressionsInfo[a].priority < expressionsInfo[b].priority);
            exprInfoSortedKeys.forEach((key) => {
                var ex = expressionsInfo[key];
                var exCode = compileExpressionCode(ex);
                expressionCode.push(exCode);
            });
            
            var code = '';
            code += plotInitCode.join('\n');
            code = code.trim();
            code += '\n\n';
            code += axInitCode.join('\n');
            code = code.trim();
            code += '\n\n';
            code += expressionCode.join('\n');
            code = code.trim();
            code += '\n\n';
            code += axDrawCode.join('\n');
            code = code.trim();
            code += '\n';
            return code;
        }
        
        var reload = function(info) {
            var reset = function() {
                var removeAllExpressions = function() {
                    for(var key in expressionsInfo) {
                        var ei = expressionsInfo[key];
                        removeExpression(ei);
                    }
                }
                var removeAllAxes = function() {
                    for(var key in axesInfo) {
                        var ai = axesInfo[key];
                        removeAxes(ai);
                    }
                }
                var removeAllPlots = function() {
                    for(var key in plotInfo) {
                        var pi = plotInfo[key];
                        removePlot(pi);
                    }
                }
                
                if(plot) plot.sleep();
                
                removeAllPlots();
                removeAllAxes();
                removeAllExpressions();
                
                $('#expressions').empty();
                $('#axes').empty();
            }
            
            var loadInfo = function(info) {
                aid = info.aid;
                axesInfo = info.axesInfo;
                eid = info.eid;
                expressionsInfo = info.expressionsInfo;
                pid = info.pid;
                plotInfo = info.plotInfo;
            }
            
            var prepareExpressionContainers = function() {
                for(var key in expressionsInfo) {
                    var ei = expressionsInfo[key];
                    addExpression(ei);
                }
            }
            
            var prepareAxesContainers = function() {
                for(var key in axesInfo) {
                    var ai = axesInfo[key];
                    addAxes(ai);
                }
            }
            
            var loadPlot = function() {
                plot = new Interactive.Plot();
                
                updateExpressions();
                
                for(var key in axesInfo) {
                    var ai = axesInfo[key];
                    updateAxes(ai);
                }
                
                for(var key in plotInfo) {
                    var pi = plotInfo[key];
                    updatePlot(pi); 
                }
            }
            
            reset();
            loadInfo(info);
            prepareExpressionContainers();
            prepareAxesContainers();
            loadPlot();
            plot.render();
        }
        
        var addAxes = function(ai) {
            var createAxesContainer = function(ai) {                    
                var axDiv = $('<div></div>');
                axDiv.css('clear', 'left');
                
                var axLabel = $('<h2></h2>');
                axLabel.text(ai.title);
                
                var axContainer = $('<div></div>');
                axContainer.css('float', 'left');
                axContainer.addClass('axes');
                axContainer.attr('id', 'ax' + ai.id);
                
                var plotSelect = $('<select></select>');
                plotSelect.append('<option>Parametric Curve</option>');
                
                var newPlotBtn = $('<input>');
                newPlotBtn.attr('type', 'button');
                newPlotBtn.attr('value', 'New Plot');
                newPlotBtn.click(() => {
                    var controls = getPlotControls({type: plotSelect.val(), axesId: ai.id});
                    controls.css('margin-top', '20px');
                    controls.css('margin-bottom', '20px');
                    plotControlContainer.append(controls);
                });
                
                var plotControlContainer = $('<div></div>');
                ai.plotIds.forEach((pid) => {
                    var controls = getPlotControls(plotInfo[pid]);
                    controls.css('margin-top', '20px');
                    controls.css('margin-bottom', '20px');
                    plotControlContainer.append(controls);
                });
                
                var removeBtn = $('<input>');
                removeBtn.attr('type', 'button');
                removeBtn.attr('value', 'Remove');
                removeBtn.click(() => {
                    removeAxes(ai);                    
                });
                
                axDiv.append(axLabel);
                axDiv.append(axContainer);
                axDiv.append(plotSelect);
                axDiv.append(newPlotBtn);
                axDiv.append(plotControlContainer);
                axDiv.append(removeBtn);
                
                $('#axes').append(axDiv);
                
                return axDiv;
            }
            
            if(ai === undefined) ai = {};
            if(ai.id === undefined) ai.id = aid++;
            if(ai.title === undefined) ai.title = 'Axes ' + ai.id;
            if(ai.type === undefined) ai.type = '2D';
            if(ai.plotIds === undefined) ai.plotIds = [];
            
            ai.container = createAxesContainer(ai); 
            
            axesInfo[ai.id] = ai;
            return ai;
        }
        
        var updateAxes = function(ai) {
            if(ai.obj) {
                plot.dropAxes(ai.obj);
                ai.obj = null;
            }
            
            if(ai.type == "2D") {
                ai.obj = plot.createAxes2D(document.getElementById('ax' + ai.id));
            } 
            if(ai.type == "3D") {
                ai.obj = plot.createAxes3D(document.getElementById('ax' + ai.id));
            }
            
            axesInfo[ai.id] = ai;
        }
        
        var removeAxes = function(ai) {
            if(ai.container) ai.container.remove();
            delete axesInfo[ai.id];
        }
        
        var addPlot = function(pi) {
            // Add entry to the global plot info set
            if(pi === undefined) pi = {};
            if(pi.id === undefined) pi.id = pid++;
            if(pi.type === undefined) return null;
            if(pi.axesId === undefined) return null;
            if(pi.valid === undefined) pi.valid = false;
            if(pi.values === undefined) pi.values = {};
            
            // Add a reference from the axes it is
            // embedded in
            axesInfo[pi.axesId].plotIds.push(pi.id);
            
            // Add the plot to the axes
            updatePlot(pi);
            
            plotInfo[pi.id] = pi;
            return pi;
        }
        
        var updatePlot = function(pi) {
            var ai = axesInfo[pi.axesId]
            
            if(pi.obj) {
                ai.obj.removeFigure(pi.obj);    
                pi.obj = null;
            }
            
            var expr = '';
            if(pi.values.expr) {
                expr += pi.values.expr;
            }
            if(pi.values.interval) {
                expr +='{';
                expr += pi.values.interval.variable;
                expr += ',';
                expr += pi.values.interval.start;
                expr += ',';
                expr += pi.values.interval.end;
                expr += ',';
                expr += pi.values.interval.steps;
                expr += '}';
            }
            
            var opts = {};
            if(pi.values.useColor) {
                opts.color = pi.values.color;
            }
            
            if(pi.valid) {
                switch(pi.type) {
                    case 'Parametric Curve':
                    pi.obj = ai.obj.plotExpression(expr, 'parametric', opts);
                    break;
                }
            }
            
            plotInfo[pi.id] = pi;
        }
        
        var removePlot = function(pi) {
            // Remove reference to this plot from the axes
            // it is embedded in
            var ai = axesInfo[pi.axesId];
            var index = ai.plotIds.indexOf(pi.id);
            ai.plotIds.splice(index, 1);
            axesInfo[pi.axesId] = ai;
            
            // Remove this plot from the axes object
            ai.obj.removeFigure(pi.obj);
            
            // Remove reference to this plot from the global
            // plot info set
            delete plotInfo[pi.id];
        }
        
        var getPlotControls = function(pi) {
            if(!plotInfo[pi.id]) pi = addPlot(pi);
            
            var intervalControl = function(values) {
                var control = $('<span></span>');
                
                var varInput = $('<input>');
                varInput.css('width', '4em')
                varInput.attr('type', 'text');
                varInput.attr('placeholder', 'e.g. x');
                if(values.variable) varInput.val(values.variable);
                
                var startInput = $('<input>');
                startInput.css('width', '4em')
                startInput.attr('type', 'text');
                startInput.attr('placeholder', 'e.g. 0');
                if(values.start) startInput.val(values.start);
                
                var endInput = $('<input>');
                endInput.css('width', '4em')
                endInput.attr('type', 'text');
                endInput.attr('placeholder', 'e.g. 1');
                if(values.end) endInput.val(values.end);
                
                var stepInput = $('<input>');
                stepInput.css('width', '4em')
                stepInput.attr('type', 'text');
                stepInput.attr('placeholder', 'e.g. 10');
                if(values.steps) stepInput.val(values.steps);
                
                control.append(varInput);
                control.append(' goes from ');
                control.append(startInput);
                control.append(' to ');
                control.append(endInput);
                control.append(' in ');
                control.append(stepInput);
                control.append(' steps ');
                
                control.getValues = function() {
                    return {
                        variable: varInput.val(),
                        start: startInput.val(),
                        end: endInput.val(),
                        steps: stepInput.val()
                    }
                }
                
                return control;
            }
            
            var loadParametricCurveControls = function() {
                var pc = $('<div></div>');
                var onchange;
                
                var removeBtn = $('<input>');
                removeBtn.attr('type', 'button');
                removeBtn.attr('value', 'X');
                removeBtn.click(() => {
                    pc.remove();
                    removePlot(pi);
                })
                
                var functionInput = $('<input>');
                functionInput.css('width', '7em');
                functionInput.attr('type', 'text');
                functionInput.attr('placeholder', 'e.g (x, x^2)');
                if(pi.values.expr) functionInput.val(pi.values.expr);
                
                var param = intervalControl(pi.values.interval || {});
                
                var colorPanel = $('<div></div>');
                
                var useColorChk = $('<input>');
                useColorChk.attr('type', 'checkbox');
                useColorChk.prop('checked', pi.values.useColor);
                useColorChk.change((e) => {
                    onchange(e, true);
                });
                
                var colorInput = $('<input>');
                colorInput.css('width', '4em');
                colorInput.attr('type', 'text');
                colorInput.val(pi.values.color)
                
                colorPanel.append(useColorChk);
                colorPanel.append('Color graph with (function): ')
                colorPanel.append(colorInput);
                colorPanel.hide();
                
                var toggleColorPanel = $('<input>');
                toggleColorPanel.attr('type', 'button');
                toggleColorPanel.attr('value', 'C');
                toggleColorPanel.click(() => {
                    colorPanel.toggle();
                });
                
                
                pc.append(removeBtn);
                pc.append('Plot ');
                pc.append(functionInput);
                pc.append('<br>');
                pc.append(' as ');
                pc.append(param);
                pc.append('<br>');
                pc.append(toggleColorPanel);
                pc.append(colorPanel);
                
                onchange = function(requestUpdate) {
                    setTimeout(()=>{                    
                        var values = param.getValues();
                        pi.values.expr = functionInput.val();
                        pi.values.interval = values;
                        pi.values.useColor = useColorChk.is(':checked');
                        pi.values.color = colorInput.val();
                        
                        // For simplicity, assume valid if all fields are non-empty
                        if(functionInput.val() != "" && values.variable != "" && values.start != ""
                        && values.end != "" && values.steps != "" 
                        && (!pi.values.useColor || pi.values.color)) {
                            pi.valid = true;
                            if(requestUpdate) updatePlot(pi) // Only update on enter
                        } else {
                            pi.valid = false;
                        }
                        plotInfo[pi.id] = pi;
                    }, 10);
                }
                pc.keypress((e) => {
                    var keycode = (e.keyCode ? e.keyCode : e.which);
                    onchange(keycode == 13);
                });
                
                return pc;
            }
            
            switch(pi.type) {
                case 'Parametric Curve':
                return loadParametricCurveControls();
                break;
            }
        }
        
        var addExpression = function(ei) {
            var createExpressionContainer = function(ei) {
                var exDiv = $('<div></div>');
                var onchange;
                
                var exInput = $('<input>');
                exInput.attr('type', 'text');
                exInput.val(ei.expr);
                
                var exRemove = $('<input>');
                exRemove.attr('type', 'button');
                exRemove.attr('value', 'X');
                exRemove.click(() => {
                    removeExpression(ei);                    
                });
                
                exDiv.append(exInput);
                exDiv.append(exRemove);
                
                onchange = function(requestUpdate) {
                    setTimeout(() => {
                        // todo: check for errors/validation before eval
                        ei.expr = exInput.val();
                        ei.valid = true;
                        expressionsInfo[ei.id] = ei; 
                        
                        if(requestUpdate) {
                            updateExpressions();
                        }
                    }, 10);
                }
                exDiv.keypress((e) => {
                    var keycode = (e.keyCode ? e.keyCode : e.which);
                    onchange(keycode == 13);
                });
                
                $('#expressions').append(exDiv); 
                
                return exDiv;
            }
            
            if(ei === undefined) ei = {};
            if(ei.id === undefined) ei.id = eid++;
            if(ei.expr === undefined) ei.expr = '';
            if(ei.valid === undefined) ei.valid = false;
            if(ei.priority === undefined) ei.priority = ei.id;
            
            ei.container = createExpressionContainer(ei);
            
            updateExpressions();
            
            expressionsInfo[ei.id] = ei;
            return ei;
        }
        
        var updateExpressions = function() {
            plot.resetContext();
            
            for(var key in expressionsInfo) {
                var ei = expressionsInfo[key];
                if(ei.valid) {
                    plot.execExpression(ei.expr);
                }
            }
         
            plot.refresh();

            // Redraw all plots
            for(var key in plotInfo) {
                var pi = plotInfo[key];
                if(pi.obj) updatePlot(pi);
            }
        }
        
        var removeExpression = function(ei) {
            if(ei.container) ei.container.remove();
            delete expressionsInfo[ei.id];
        }
        
        // File IO
        
        var download = function(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            
            element.style.display = 'none';
            document.body.appendChild(element);
            
            element.click();
            
            document.body.removeChild(element);
        };
        
        var save = function() {
            var info = {};
            info.aid = aid;
            info.axesInfo = axesInfo;
            info.eid = eid;
            info.expressionsInfo = expressionsInfo;
            info.pid = pid;
            info.plotInfo = plotInfo;
            
            var replacer = function(key, value) {
                if(key == 'container') return undefined;
                if(key == 'obj') return undefined;
                return value;
            }
            
            var str = JSON.stringify(info, replacer);
            download('plot.json', str);
        }
        
        var load = function(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                var contents = e.target.result;
                
                var info = JSON.parse(contents);
                reload(info);
            };
            reader.readAsText(file);
        };
        
        var exprt = function() {
            download('plotCode.js', compile());
        }
        
        // Animate
        
        ;(function animate() {
            requestAnimationFrame(animate);
            plot.render();
        })();
        
        //  Hooks/Handlers
        
        ;(function() {
            $('#save').click(save);
            $('#load').change(load);
            $('#export').click(exprt);
            $('#addaxes').click(() => {
                var type = $('#axestype').val();
                addAxes({type: type});
            });
            $('#addexpr').click(() => {
                addExpression();
            });
        })();
    </script>
</body>